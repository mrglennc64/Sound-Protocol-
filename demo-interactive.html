<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roya | Sound & Music Protocol Technology | Evaluation Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0F1B3D;
            --secondary: #10B981;
            --accent: #FFD700;
            --blockchain: #8B5CF6;
            --light: #F8FAFC;
            --dark: #0F172A;
            --gray: #64748B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --radius: 12px;
            --shadow: 0 10px 25px rgba(15, 27, 61, 0.1);
            --gradient: linear-gradient(135deg, #0F1B3D 0%, #1E3A8A 100%);
            --gradient-green: linear-gradient(135deg, #10B981 0%, #059669 100%);
            --gradient-purple: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }

        body::after {
            content: 'Roya-Demo-Evaluation-' attr(data-user) '-' attr(data-timestamp);
            position: fixed;
            bottom: 5px;
            right: 5px;
            opacity: 0.01;
            font-size: 6px;
            color: transparent;
            pointer-events: none;
            user-select: none;
            z-index: 10000;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
            color: white;
            max-width: 600px;
            padding: 40px;
        }

        .loading-logo {
            font-size: 48px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .loading-facts {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .loading-fact {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            backdrop-filter: blur(10px);
        }

        .demo-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            border: 3px solid var(--primary);
        }

        .live-banner {
            background: linear-gradient(90deg, var(--success) 0%, #0DA271 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 4px solid var(--accent);
        }

        .live-banner-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .demo-header {
            background: var(--gradient);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .demo-header::before {
            content: 'ðŸ”’';
            position: absolute;
            font-size: 300px;
            opacity: 0.05;
            right: -50px;
            top: -50px;
            transform: rotate(15deg);
        }

        .logo {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .subtitle {
            font-size: 18px;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto 20px;
            font-weight: 400;
            line-height: 1.6;
        }

        .demo-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.5);
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.5px;
            margin-top: 20px;
        }

        .tab-container {
            display: flex;
            gap: 1px;
            background: #E2E8F0;
            padding: 0 40px;
            border-radius: 0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            background: white;
            border: none;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            position: relative;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab:hover:not(.active) {
            background: #F8FAFC;
            color: var(--dark);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            min-height: 800px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .upload-panel {
            background: var(--light);
            padding: 40px 30px;
            border-right: 1px solid #E2E8F0;
        }

        .upload-section {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 2px dashed #CBD5E1;
            transition: all 0.3s;
        }

        .upload-section.drag-over {
            border-color: var(--secondary);
            background: rgba(16, 185, 129, 0.05);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background: var(--light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            font-size: 32px;
            color: var(--primary);
        }

        .upload-instructions {
            text-align: center;
            margin-bottom: 25px;
        }

        .file-input-container {
            position: relative;
            margin-bottom: 25px;
        }

        .file-input {
            width: 100%;
            padding: 20px;
            border: 2px dashed #CBD5E1;
            border-radius: var(--radius);
            background: var(--light);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .supported-formats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .format-badge {
            background: white;
            border: 1px solid #E2E8F0;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .preview-section {
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #E2E8F0;
        }

        .file-info {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .file-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .info-item {
            padding: 15px;
            background: var(--light);
            border-radius: var(--radius);
        }

        .info-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        .info-value.verified {
            color: var(--success);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1E3A8A;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(15, 27, 61, 0.2);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--light);
            transform: translateY(-3px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #0DA271;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
        }

        .visualization-panel {
            padding: 40px;
            background: white;
            position: relative;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .split-visualization {
            padding: 20px 0;
        }

        .split-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .split-header h2 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .pie-chart-container {
            width: 300px;
            height: 300px;
            margin: 40px auto;
            position: relative;
        }

        .pie-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .pie-center {
            position: absolute;
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-width: 200px;
        }

        .blockchain-section {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            margin-top: 40px;
            box-shadow: var(--shadow);
            border: 2px solid #E2E8F0;
        }

        .blockchain-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .tx-details {
            background: #0F1B3D;
            color: white;
            border-radius: var(--radius);
            padding: 25px;
            font-family: monospace;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .tx-label {
            color: #94A3B8;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tx-value {
            color: white;
            font-size: 16px;
            word-break: break-all;
            margin-bottom: 15px;
        }

        .explorer-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--blockchain);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .payment-flow {
            padding: 20px 0;
        }

        .payment-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 50px 0;
            position: relative;
        }

        .payment-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: #E2E8F0;
            z-index: 1;
        }

        .payment-step {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
            z-index: 2;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .payment-step.active {
            background: var(--success);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.3);
        }

        .payment-step.completed {
            background: var(--success);
            color: white;
        }

        .payment-details {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            margin-top: 40px;
            box-shadow: var(--shadow);
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .payment-card {
            padding: 25px;
            background: var(--light);
            border-radius: var(--radius);
            border-left: 4px solid var(--secondary);
        }

        .payment-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        /* Progress Steps from first HTML */
        .progress-steps {
            display: flex;
            justify-content: center;
            margin: 40px 0 30px;
            position: relative;
        }
        
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 50px;
            right: 50px;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        
        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            width: 200px;
        }
        
        .step-circle {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            margin: 0 auto 10px;
            transition: all 0.5s ease;
            font-size: 18px;
        }
        
        .step.active .step-circle {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 184, 212, 0.5);
        }
        
        .step.completed .step-circle {
            background: var(--success);
            border-color: var(--success);
        }
        
        .step-label {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .step.active .step-label {
            color: white;
        }

        /* Swedish Features */
        .swedish-features {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 40px 0;
            border: 3px solid #90caf9;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .feature-item {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #006aa8;
        }

        /* Evaluation Disclaimer */
        .evaluation-disclaimer {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 30px;
            font-size: 14px;
            color: var(--dark);
        }

        .evaluation-disclaimer h4 {
            color: var(--warning);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: block !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-30 {
            margin-bottom: 30px;
        }
        
        .mt-30 {
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .progress-steps {
                flex-wrap: wrap;
                gap: 30px;
            }
            
            .progress-steps::before {
                display: none;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-user="demo-viewer" data-timestamp="">
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="fas fa-bolt"></i>
                <span>Roya</span>
            </div>
            <h2>Loading Evaluation Demo</h2>
            <div class="loading-facts">
                <div class="loading-fact">
                    <i class="fas fa-check"></i>
                    <span>Deployed on Monad Testnet (Evaluation Environment)</span>
                </div>
                <div class="loading-fact">
                    <i class="fas fa-check"></i>
                    <span>Smart Contract for Transparency Evaluation</span>
                </div>
                <div class="loading-fact">
                    <i class="fas fa-check"></i>
                    <span>Swedish Music Industry Workflow</span>
                </div>
                <div class="loading-fact">
                    <i class="fas fa-check"></i>
                    <span>Verifiable Execution Reference</span>
                </div>
            </div>
            <div style="margin-top: 30px;">
                <div style="width: 100%; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; overflow: hidden;">
                    <div id="loadingBar" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.5s ease;"></div>
                </div>
                <p style="margin-top: 10px; opacity: 0.8; font-size: 14px;">Initializing Roya evaluation environment...</p>
            </div>
        </div>
    </div>

    <!-- Main Demo Container -->
    <div class="demo-container">
        <!-- Live Infrastructure Banner -->
        <div class="live-banner">
            <div class="live-banner-content">
                <i class="fas fa-broadcast-tower" style="font-size: 20px;"></i>
                <div>
                    <strong>Deployed on Monad Testnet (Evaluation Environment)</strong>
                    <div style="font-size: 13px; opacity: 0.9;">
                        Prototype contract deployed on-chain for transparency and evaluation
                    </div>
                </div>
            </div>
            <div style="font-size: 12px; opacity: 0.9; background: rgba(255, 255, 255, 0.2); padding: 5px 12px; border-radius: 20px;">
                Roya Verification Prototype
            </div>
        </div>

        <!-- Header -->
        <div class="demo-header">
            <div class="logo">
                <i class="fas fa-music"></i>
                <span>Roya â€“ Transparency & Verification Layer for Swedish Music Publishing</span>
            </div>
            <p class="subtitle">
                A transparency and verification layer for Swedish music publishing workflows<br>
                <span style="color: var(--accent); font-weight: 600;">
                    Verifiable â€¢ Reviewable â€¢ Interactive â€¢ Roya
                </span>
            </p>
            
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Upload & Parse</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Verification & Execution Reference</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Payment Instruction Simulation</div>
                </div>
            </div>
            
            <div class="demo-status" id="demoStatus">
                <i class="fas fa-bolt"></i>
                <span>Royalty Verification Prototype Live on Monad Testnet â€¢ CHAIN ID: 10143</span>
            </div>
        </div>

        <!-- Tab Container -->
        <div class="tab-container">
            <button class="tab active" onclick="switchTab('upload')">
                <i class="fas fa-cloud-upload-alt"></i>
                Upload & Parse
            </button>
            <button class="tab" onclick="switchTab('blockchain')">
                <i class="fas fa-link"></i>
                Verification & Execution Reference
            </button>
            <button class="tab" onclick="switchTab('payments')">
                <i class="fas fa-money-check-alt"></i>
                Payment Instruction Simulation
            </button>
        </div>

        <div class="main-layout">
            <div class="upload-panel">
                <!-- Upload Tab -->
                <div id="uploadTab" class="tab-content active">
                    <div class="upload-section" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-instructions">
                            <h3>Upload Your Split Sheet</h3>
                            <p>Upload a CSV, Excel, or PDF file containing song metadata and royalty splits. We convert the data into a verifiable execution reference deployed as a smart contract in a test environment, designed to support Swedish royalty and tax reporting workflows.</p>
                        </div>

                        <div class="file-input-container">
                            <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls,.pdf,.json" onchange="handleFileSelect(event)">
                        </div>

                        <div class="supported-formats">
                            <div class="format-badge">
                                <i class="fas fa-file-csv"></i>
                                CSV
                            </div>
                            <div class="format-badge">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </div>
                            <div class="format-badge">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </div>
                            <div class="format-badge">
                                <i class="fas fa-file-code"></i>
                                JSON
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 30px; color: var(--gray); font-size: 14px;">
                            <p>Or try with our <a href="#" style="color: var(--secondary); font-weight: 600;" onclick="loadSampleData(); return false;">sample STIM split sheet</a></p>
                        </div>
                    </div>

                    <!-- Evaluation Demo Section -->
                    <div class="swedish-features">
                        <h3 class="text-center mb-30">Interactive Evaluation Demo</h3>
                        <div class="features-grid" style="display: flex; justify-content: center; align-items: flex-start;">
                            <div class="feature-item" style="max-width: 520px; width: 100%; margin: 0 auto;">
                                <p>Experience the full Roya verification workflow with our evaluation demonstration.</p>
                                <ul style="margin-top: 1em;">
                                    <li><strong>Upload:</strong> Upload a sample STIM royalty report</li>
                                    <li><strong>Verify:</strong> Watch as Roya validates splits and calculations</li>
                                    <li><strong>Generate:</strong> Create an immutable execution reference</li>
                                    <li><strong>Export:</strong> Generate sample payment instructions for downstream accounting or payment systems</li>
                                </ul>
                                
                                <!-- Evaluation Disclaimer -->
                                <div class="evaluation-disclaimer mt-30">
                                    <h4>
                                        <i class="fas fa-info-circle"></i>
                                        Evaluation Environment Notice
                                    </h4>
                                    <p>This is a testnet demonstration for evaluation purposes only. No real financial transactions occur. Roya does not custody funds or initiate payments. All smart contracts are deployed in test environments for transparency and review.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="preview-section" id="previewSection">
                        <div class="preview-header">
                            <h3>
                                <i class="fas fa-eye"></i>
                                File Preview
                            </h3>
                            <button class="btn-secondary" onclick="clearUpload()" style="padding: 10px 20px; font-size: 14px;">
                                <i class="fas fa-times"></i>
                                Clear
                            </button>
                        </div>

                        <div class="file-info">
                            <div class="file-info-grid" id="fileInfoGrid">
                            </div>
                        </div>

                        <!-- Parsed Data Display -->
                        <div id="parsedDataSection" style="margin-top: 25px; display: none;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-table"></i>
                                Parsed Split Data
                            </h4>
                            
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background: var(--primary); color: white;">
                                            <th style="padding: 12px 15px; text-align: left;">Contributor</th>
                                            <th style="padding: 12px 15px; text-align: left;">Share %</th>
                                            <th style="padding: 12px 15px; text-align: left;">Role</th>
                                            <th style="padding: 12px 15px; text-align: left;">Wallet</th>
                                        </tr>
                                    </thead>
                                    <tbody id="parsedDataTable">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: var(--light);">
                                            <td style="padding: 12px 15px; font-weight: 600;">Total</td>
                                            <td style="padding: 12px 15px; font-weight: 600;" id="totalPercentageDisplay">100%</td>
                                            <td style="padding: 12px 15px;">â€”</td>
                                            <td style="padding: 12px 15px;">â€”</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="createSmartContract()" id="createContractBtn">
                                <i class="fas fa-file-contract"></i>
                                Create Execution Reference
                            </button>
                            <button class="btn btn-success" onclick="downloadPDF()" id="downloadPdfBtn" style="display: none;">
                                <i class="fas fa-file-pdf"></i>
                                Download Verification Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Blockchain Tab -->
                <div id="blockchainTab" class="tab-content">
                    <div class="blockchain-section">
                        <div class="blockchain-header">
                            <i class="fas fa-link"></i>
                            <h3>Execution Reference Verification</h3>
                        </div>
                        
                        <div class="tx-details">
                            <div class="tx-label">Prototype Contract Address (Evaluation)</div>
                            <div class="tx-value" style="color: var(--accent); font-weight: 700;">
                                0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4
                            </div>
                            
                            <div class="tx-label">Evaluation Network</div>
                            <div class="tx-value">
                                Monad Testnet â€¢ Chain ID: 10143 (0x279f) â€¢ Evaluation Environment
                            </div>
                            
                            <div class="tx-label">Verification Status</div>
                            <div class="tx-value" style="color: var(--success);">
                                âœ… <strong>DEPLOYED FOR TRANSPARENCY REVIEW</strong>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                            <a href="https://testnet.monadexplorer.com/address/0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4" 
                               class="explorer-link" 
                               target="_blank">
                                <i class="fas fa-external-link-alt"></i>
                                View Contract on Explorer
                            </a>
                            
                            <a href="https://testnet.monadexplorer.com/address/0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4#code" 
                               class="explorer-link" 
                               style="background: var(--success);"
                               target="_blank">
                                <i class="fas fa-code"></i>
                                Review Contract Source Code
                            </a>
                        </div>
                    </div>

                    <div style="background: white; border-radius: var(--radius); padding: 25px; margin-top: 30px; box-shadow: var(--shadow);">
                        <h4 style="color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-wallet"></i>
                            Web3 Wallet Connection (Optional)
                        </h4>
                        <p style="color: var(--gray); font-size: 14px; margin-bottom: 20px;">
                            Connect MetaMask to interact with the Monad Testnet evaluation environment. This is for demonstration purposes only.
                        </p>
                        <button class="btn btn-success" onclick="connectWallet()" style="width: 100%;" id="connectBtn">
                            <i class="fas fa-wallet"></i>
                            Connect MetaMask (Demo)
                        </button>
                        <div id="walletStatus" style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: var(--radius); display: none;">
                        </div>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div id="paymentsTab" class="tab-content">
                    <div style="padding: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 20px;">
                            <i class="fas fa-money-check-alt"></i>
                            Payment Instruction Simulation
                        </h3>
                        <p style="color: var(--gray); margin-bottom: 30px;">
                            Simulate royalty distribution and view sample payment instructions generated from the execution reference.
                        </p>
                        
                        <button class="btn btn-success" onclick="simulatePayment()" style="width: 100%; padding: 20px; font-size: 18px;" id="simulatePaymentBtn">
                            <i class="fas fa-play"></i>
                            Simulate $50,000 Royalty Distribution (Sample)
                        </button>

                        <div class="evaluation-disclaimer mt-30">
                            <h4>
                                <i class="fas fa-info-circle"></i>
                                Simulation Notice
                            </h4>
                            <p>This simulation generates sample payment instructions for evaluation purposes. No actual payments are initiated. The output is designed for review by accounting or payment systems for workflow evaluation.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="visualization-panel">
                <div id="uploadVisualization" class="tab-content active">
                    <div class="split-visualization">
                        <div class="split-header">
                            <h2>Royalty Split Visualization</h2>
                            <p>Your uploaded split sheet visualized as percentage distributions</p>
                        </div>

                        <div class="pie-chart-container">
                            <div class="pie-chart" id="pieChart"></div>
                            <div class="pie-center">
                                <div class="total" id="totalPercentage">0%</div>
                                <div class="label">Total Splits</div>
                            </div>
                        </div>

                        <div class="legend" id="legendContainer">
                        </div>
                    </div>
                </div>

                <div id="blockchainVisualization" class="tab-content">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="width: 150px; height: 150px; background: rgba(139, 92, 246, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px;">
                            <i class="fas fa-link" style="font-size: 60px; color: var(--blockchain);"></i>
                        </div>
                        <h2 style="color: var(--primary); margin-bottom: 15px;">Execution Reference Deployed</h2>
                        <p style="color: var(--gray); max-width: 600px; margin: 0 auto 30px;">
                            Your split sheet data has been converted into a verifiable execution reference deployed on Monad Testnet for transparency review.
                        </p>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: var(--radius); margin: 40px 0;">
                            <h4 style="color: var(--success); margin-bottom: 10px;">
                                <i class="fas fa-check-circle"></i>
                                Available for Technical Review
                            </h4>
                            <p style="color: var(--gray); font-size: 14px;">
                                Contract deployed at: 0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4
                            </p>
                        </div>
                    </div>
                </div>

                <div id="paymentsVisualization" class="tab-content">
                    <div class="payment-flow">
                        <div class="split-header">
                            <h2>Sample Payment Distribution Simulation</h2>
                            <p>Review how royalty distributions would flow based on execution reference</p>
                        </div>

                        <div class="payment-steps">
                            <div class="payment-step" id="paymentStep1">
                                <div class="step-number">1</div>
                                <div class="step-label">Royalty Received</div>
                            </div>
                            <div class="payment-step" id="paymentStep2">
                                <div class="step-number">2</div>
                                <div class="step-label">Split Calculation</div>
                            </div>
                            <div class="payment-step" id="paymentStep3">
                                <div class="step-number">3</div>
                                <div class="step-label">Instruction Generation</div>
                            </div>
                            <div class="payment-step" id="paymentStep4">
                                <div class="step-number">4</div>
                                <div class="step-label">Review Complete</div>
                            </div>
                        </div>

                        <div class="payment-details" id="paymentDetails" style="display: none;">
                            <div class="payment-grid">
                                <div class="payment-card">
                                    <div class="payment-amount" id="totalPayment">$50,000</div>
                                    <div class="payment-label">Sample Royalty Amount</div>
                                </div>
                                <div class="payment-card success">
                                    <div class="payment-amount" id="distributedAmount">$50,000</div>
                                    <div class="payment-label">100% Allocated to Contributors</div>
                                </div>
                                <div class="payment-card">
                                    <div class="payment-amount">$0</div>
                                    <div class="payment-label">Roya Fee (0%)</div>
                                </div>
                                <div class="payment-card warning">
                                    <div class="payment-amount">0.3s</div>
                                    <div class="payment-label">Simulation Time</div>
                                </div>
                            </div>

                            <div style="background: var(--light); padding: 25px; border-radius: var(--radius); margin-top: 30px;">
                                <h4 style="color: var(--primary); margin-bottom: 20px;">
                                    <i class="fas fa-users"></i>
                                    Sample Payment Distribution (For Review)
                                </h4>
                                <div id="paymentDistribution">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="padding: 40px; background: linear-gradient(135deg, #0F1B3D 0%, #1E3A8A 100%); color: white; border-top: 4px solid var(--accent);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; margin-bottom: 30px;">
                <div>
                    <h4 style="color: white; margin-bottom: 15px;">
                        <i class="fas fa-rocket"></i>
                        Evaluation Environment
                    </h4>
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.6;">
                        This demo uses smart contracts deployed on Monad Testnet exclusively for testing, evaluation, and transparency review.
                    </p>
                </div>
                
                <div>
                    <h4 style="color: white; margin-bottom: 15px;">
                        <i class="fas fa-graduation-cap"></i>
                        Technical Evaluation
                    </h4>
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.6;">
                        Built for ecosystem grants and technical evaluation. Demonstrates verifiable execution logic, on-chain transparency, and reviewable documentation.
                    </p>
                </div>
                
                <div>
                    <h4 style="color: white; margin-bottom: 15px;">
                        <i class="fas fa-external-link-alt"></i>
                        Explorer Links (Review)
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <a href="https://testnet.monadexplorer.com/address/0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4" 
                           target="_blank" 
                           style="color: var(--accent); text-decoration: none; font-size: 14px;">
                            â€¢ Contract Address (Review)
                        </a>
                        <a href="https://testnet.monadexplorer.com/address/0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4#code" 
                           target="_blank" 
                           style="color: var(--accent); text-decoration: none; font-size: 14px;">
                            â€¢ Verified Source Code (Review)
                        </a>
                        <a href="https://faucet.monad.xyz" 
                           target="_blank" 
                           style="color: var(--accent); text-decoration: none; font-size: 14px;">
                            â€¢ Monad Testnet Faucet
                        </a>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; padding-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <p style="color: rgba(255, 255, 255, 0.6); font-size: 14px;">
                    Roya â€¢ Royalty Verification Infrastructure (Prototype) â€¢ Live on Monad Testnet â€¢ STIM/NCB Workflow Evaluation
                </p>
                <p style="color: rgba(255, 255, 255, 0.4); font-size: 12px; margin-top: 10px;">
                    Built for ecosystem grants and investor review. Contract: 0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4
                </p>
                <p style="color: rgba(255, 255, 255, 0.3); font-size: 11px; margin-top: 10px; font-style: italic;">
                    This is an evaluation prototype. No financial transactions occur. All outputs are for review and workflow evaluation purposes.
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== LOADING SCREEN ====================
        document.addEventListener('DOMContentLoaded', function() {
            simulateLoading();
            initializeDemo();
        });

        function simulateLoading() {
            const loadingBar = document.getElementById('loadingBar');
            const loadingScreen = document.getElementById('loadingScreen');
            const demoContainer = document.querySelector('.demo-container');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                loadingBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                            demoContainer.style.display = 'block';
                        }, 500);
                    }, 500);
                }
            }, 200);
        }

        const CONFIG = {
            DEMO_CONTRACT_ADDRESS: '0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4',
            MONAD_TESTNET: {
                chainId: '0x279f',
                chainName: 'Monad Testnet',
                nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
                rpcUrls: ['https://testnet-rpc.monad.xyz'],
                blockExplorerUrls: ['https://testnet.monadexplorer.com']
            }
        };

        // ==================== SMART PARSING ENGINE ====================
        class SmartParser {
            constructor() {
                this.columnMappings = {
                    name: ['name', 'contributor', 'artist', 'writer', 'author', 'creator', 'performer', 'musician'],
                    percentage: ['percentage', 'share', 'split', 'pct', 'royalty', 'percent', '%', 'share %'],
                    role: ['role', 'type', 'position', 'job', 'function', 'contributor type'],
                    wallet: ['wallet', 'address', 'eth address', 'crypto wallet', 'blockchain address', 'public key'],
                    ipi: ['ipi', 'ipi number', 'ipi code', 'international performer identification']
                };
            }

            parseFile(file, content) {
                console.log("ðŸ” Smart Parser: Processing file:", file.name);
                
                try {
                    const fileExt = file.name.split('.').pop().toLowerCase();
                    
                    let parsedData;
                    let corrections = 0;
                    if (fileExt === 'csv') {
                        const result = this.parseCSV(content);
                        parsedData = result.data;
                        corrections = result.corrections;
                    } else {
                        const result = this.parseCSV(content);
                        parsedData = result.data;
                        corrections = result.corrections;
                    }
                    
                    parsedData = this.autoCorrect(parsedData);
                    
                    console.log("âœ… Successfully parsed", parsedData.length, "contributors");
                    return { success: true, data: parsedData, corrections: corrections };
                    
                } catch (error) {
                    console.error("âŒ Parser error:", error);
                    return { success: false, data: [], error: error.message, corrections: 0 };
                }
            }

            parseCSV(content) {
                const lines = content.split('\n').filter(line => line.trim());
                if (lines.length === 0) return [];
                
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const mappedHeaders = this.mapHeaders(headers);
                
                console.log("ðŸ“Š Original headers:", headers);
                console.log("ðŸ”„ Mapped to:", mappedHeaders);
                
                const data = [];
                const corrections = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const row = this.parseCSVRow(lines[i]);
                    if (row.length === 0) continue;
                    
                    const contributor = {};
                    
                    mappedHeaders.forEach((stdHeader, index) => {
                        if (index < row.length && stdHeader) {
                            const value = row[index].trim();
                            
                            switch(stdHeader) {
                                case 'name':
                                    contributor.name = this.cleanName(value);
                                    break;
                                case 'percentage':
                                    contributor.percentage = this.cleanPercentage(value);
                                    break;
                                case 'role':
                                    contributor.role = this.cleanRole(value);
                                    break;
                                case 'wallet':
                                    contributor.wallet = this.cleanWallet(value);
                                    break;
                            }
                        }
                    });
                    
                    // Auto-fill missing values
                    if (!contributor.name) {
                        contributor.name = `Contributor ${i}`;
                        corrections.push(`Row ${i}: Added default name`);
                    }
                    
                    if (!contributor.percentage) {
                        contributor.percentage = 0;
                        corrections.push(`Row ${i}: Set percentage to 0`);
                    }
                    
                    if (!contributor.role) {
                        contributor.role = 'Contributor';
                        corrections.push(`Row ${i}: Added default role`);
                    }
                    
                    if (!contributor.wallet) {
                        contributor.wallet = this.generateWallet(contributor.name, i);
                        corrections.push(`Row ${i} (${contributor.name}): Generated wallet address`);
                    }
                    
                    if (contributor.percentage > 0) {
                        data.push(contributor);
                    }
                }
                
                // Show corrections
                if (corrections.length > 0) {
                    console.log("âœ… Auto-corrections made:");
                    corrections.forEach(c => console.log("  â€¢ " + c));
                }
                
                const total = data.reduce((sum, item) => sum + item.percentage, 0);
                if (data.length > 0 && Math.abs(total - 100) > 0.01) {
                    corrections.push(`Normalized percentages from ${total.toFixed(1)}% to 100%`);
                    console.log(`ðŸ”„ Normalizing percentages from ${total.toFixed(1)}% to 100%`);
                    this.normalizePercentages(data, total);
                }
                
                return { data: data, corrections: corrections.length };
            }

            mapHeaders(headers) {
                return headers.map(header => {
                    header = header.toLowerCase().trim();
                    
                    for (const [stdHeader, variations] of Object.entries(this.columnMappings)) {
                        if (variations.some(v => header.includes(v) || v.includes(header))) {
                            return stdHeader;
                        }
                    }
                    
                    if (header.includes('name') || header.includes('artist')) return 'name';
                    if (header.includes('%') || header.includes('share')) return 'percentage';
                    if (header.includes('role') || header.includes('type')) return 'role';
                    if (header.includes('wallet') || header.includes('address')) return 'wallet';
                    
                    return null;
                });
            }

            cleanName(name) {
                if (!name || name.trim() === '') return 'Unknown';
                return name.trim().split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join(' ');
            }

            cleanPercentage(value) {
                if (!value && value !== 0) return 0;
                
                let strValue = String(value).trim().replace(/%/g, '').replace(',', '.');
                let num = parseFloat(strValue);
                
                if (num > 0 && num < 1) num = num * 100;
                
                return Math.min(Math.max(num, 0), 100);
            }

            cleanRole(role) {
                if (!role) return 'Contributor';
                
                const roleMap = {
                    'prod': 'Producer', 'producer': 'Producer',
                    'vocal': 'Vocals', 'vocals': 'Vocals', 'singer': 'Vocals',
                    'writer': 'Writer', 'composer': 'Writer',
                    'publisher': 'Publisher', 'label': 'Publisher',
                    'mix': 'Mix Engineer', 'master': 'Mastering Engineer'
                };
                
                role = role.trim().toLowerCase();
                for (const [key, value] of Object.entries(roleMap)) {
                    if (role.includes(key)) return value;
                }
                
                return role.charAt(0).toUpperCase() + role.slice(1);
            }

            cleanWallet(wallet) {
                if (!wallet || wallet.trim() === '') {
                    return this.generateWallet('default', Math.random());
                }
                
                wallet = wallet.trim();
                if (!wallet.startsWith('0x')) wallet = '0x' + wallet;
                if (wallet.length < 10) wallet = wallet.padEnd(42, '0');
                
                return wallet;
            }

            generateWallet(name, seed) {
                const hash = this.simpleHash(name + seed);
                return '0x' + hash.substring(0, 40);
            }

            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = ((hash << 5) - hash) + str.charCodeAt(i);
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16).padStart(40, '0');
            }

            parseCSVRow(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result;
            }

            normalizePercentages(data, currentTotal) {
                if (currentTotal === 0) {
                    const equalShare = 100 / data.length;
                    data.forEach(item => item.percentage = Math.round(equalShare * 100) / 100);
                } else {
                    const scale = 100 / currentTotal;
                    data.forEach(item => {
                        item.percentage = Math.round(item.percentage * scale * 100) / 100;
                    });
                    
                    const newTotal = data.reduce((sum, item) => sum + item.percentage, 0);
                    if (newTotal !== 100) {
                        data[0].percentage += (100 - newTotal);
                        data[0].percentage = Math.round(data[0].percentage * 100) / 100;
                    }
                }
            }

            autoCorrect(data) {
                return data.map((item, index) => ({
                    name: this.cleanName(item.name || `Contributor ${index + 1}`),
                    percentage: Number(this.cleanPercentage(item.percentage || 0)),
                    role: this.cleanRole(item.role || 'Contributor'),
                    wallet: this.cleanWallet(item.wallet || ''),
                }));
            }
        }

        // ==================== DEMO INITIALIZATION ====================
        let smartParser = new SmartParser();
        let currentData = [];
        let userWallet = null;
        let web3 = null;
        let steps = null;

        const COLORS = ['#FF6B35', '#10B981', '#3B82F6', '#8B5CF6', '#F59E0B', '#EC4899', '#14B8A6'];

        function initializeDemo() {
            // Sample data for Swedish publishing
            window.swedishRoyaltyData = [
                { name: "Erik Svensson", iswc: "T-345.678.123-1", share: 40, amount: 57026.80, tax: 14256.70, net: 42770.10 },
                { name: "Anna Berg", iswc: "T-987.654.321-2", share: 25, amount: 35641.75, tax: 8910.44, net: 26731.31 },
                { name: "Lars Johansson", iswc: "T-123.456.789-3", share: 15, amount: 21385.05, tax: 5346.26, net: 16038.79 },
                { name: "Sofia Andersson", iswc: "T-789.123.456-4", share: 10, amount: 14256.70, tax: 3564.18, net: 10692.53 },
                { name: "Marcus Nilsson", iswc: "T-456.789.123-5", share: 5, amount: 7128.35, tax: 1782.09, net: 5346.26 },
                { name: "Emma Karlsson", iswc: "T-234.567.891-6", share: 3, amount: 4277.01, tax: 1069.25, net: 3207.76 },
                { name: "David Lindgren", iswc: "T-891.234.567-7", share: 1.5, amount: 2138.51, tax: 534.63, net: 1603.88 },
                { name: "Ida Pettersson", iswc: "T-567.891.234-8", share: 0.5, amount: 712.84, tax: 178.21, net: 534.63 }
            ];

            // Initialize steps
            steps = document.querySelectorAll('.step');
            
            document.body.setAttribute('data-timestamp', new Date().toISOString());
            
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
            }
            
            console.log('%cðŸ”’ Roya - Evaluation Environment', 'color: #FFD700; font-size: 16px; font-weight: bold;');
            console.log('%cThis demo shows verification infrastructure for evaluation purposes.', 'color: #10B981;');
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            // Remove active class from all tabs and contents
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            // Activate the clicked tab button
            tabs.forEach(tab => {
                if (tab.getAttribute('onclick').includes(tabName)) {
                    tab.classList.add('active');
                }
            });
            
            // Activate the corresponding content sections
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.getElementById(tabName + 'Visualization').classList.add('active');
            
            // Update progress steps
            if (steps) {
                steps.forEach(step => step.classList.remove('active', 'completed'));
                
                if (tabName === 'upload') {
                    steps[0].classList.add('active');
                } else if (tabName === 'blockchain') {
                    steps[0].classList.add('completed');
                    steps[1].classList.add('active');
                } else if (tabName === 'payments') {
                    steps[0].classList.add('completed');
                    steps[1].classList.add('completed');
                    steps[2].classList.add('active');
                }
            }
        }

        // ==================== FILE HANDLING ====================
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ðŸ“ File selected:', file.name);
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt === 'xlsx' || fileExt === 'xls') {
                // Handle Excel files with XLSX library
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        console.log('Excel parsed:', jsonData);
                        
                        // Convert to CSV format for Smart Parser
                        const headers = Object.keys(jsonData[0] || {});
                        const csvContent = headers.join(',') + '\n' + 
                            jsonData.map(row => headers.map(h => row[h] || '').join(',')).join('\n');
                        
                        const result = smartParser.parseFile(file, csvContent);
                        
                        if (result.success && result.data.length > 0) {
                            currentData = result.data;
                            displayFileInfo(file.name, result.data.length, result.corrections || 0);
                            displayParsedData(result.data);
                            updateVisualization(result.data);
                            document.getElementById('previewSection').style.display = 'block';
                            document.getElementById('downloadPdfBtn').style.display = 'inline-flex';
                            
                            // Show success with summary
                            const total = result.data.reduce((sum, c) => sum + c.percentage, 0);
                            console.log(`âœ… SUCCESS: Parsed ${result.data.length} contributors, ${total.toFixed(1)}% total`);
                            if (result.corrections > 0) {
                                console.log(`ðŸ”§ Auto-corrections applied: ${result.corrections}`);
                            }
                        } else {
                            alert('Could not parse Excel file.\n\nPlease ensure your file has:\nâ€¢ Name column\nâ€¢ Percentage or Split column\n\nCheck the console (F12) for details.');
                        }
                    } catch (error) {
                        console.error('Excel error:', error);
                        alert('Error parsing Excel file: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // Handle CSV and other text files
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const result = smartParser.parseFile(file, content);
                    
                    if (result.success && result.data.length > 0) {
                        currentData = result.data;
                        displayFileInfo(file.name, result.data.length, result.corrections || 0);
                        displayParsedData(result.data);
                        updateVisualization(result.data);
                        document.getElementById('previewSection').style.display = 'block';
                        document.getElementById('downloadPdfBtn').style.display = 'inline-flex';
                        
                        // Show success with summary
                        const total = result.data.reduce((sum, c) => sum + c.percentage, 0);
                        console.log(`âœ… SUCCESS: Parsed ${result.data.length} contributors, ${total.toFixed(1)}% total`);
                        if (result.corrections > 0) {
                            console.log(`ðŸ”§ Auto-corrections applied: ${result.corrections}`);
                        }
                    } else {
                        const errorMsg = 'Could not parse file.\n\n' +
                            'Please ensure your file has:\n' +
                            'â€¢ Name (or Contributor/Artist) column\n' +
                            'â€¢ Percentage (or Split/Share/%) column\n\n' +
                            'Open browser console (F12) for detailed error info.';
                        alert(errorMsg);
                        console.error('Parse failed:', result.error);
                    }
                };
                reader.readAsText(file);
            }
        }
        
        function loadSampleData() {
            // Use sample data but adapt to format
            const sampleData = swedishRoyaltyData.map(item => ({
                name: item.name,
                percentage: item.share,
                wallet: generateSampleWallet(item.name),
                role: getRoleFromName(item.name)
            }));
            
            currentData = sampleData;
            displayFileInfo('sample-stim-report.csv', sampleData.length, 0);
            displayParsedData(sampleData);
            updateVisualization(sampleData);
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('downloadPdfBtn').style.display = 'inline-flex';
            
            // Update progress steps
            steps[0].classList.add('completed');
            steps[1].classList.add('active');
            
            console.log(`âœ… Loaded sample STIM data for evaluation: ${sampleData.length} contributors`);
        }
        
        function generateSampleWallet(name) {
            const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return '0x' + hash.toString(16).padStart(40, '0').substring(0, 40);
        }
        
        function getRoleFromName(name) {
            if (name.includes('Svensson')) return 'Producer';
            if (name.includes('Berg')) return 'Vocalist';
            if (name.includes('Johansson')) return 'Writer';
            if (name.includes('Andersson')) return 'Musician';
            if (name.includes('Nilsson')) return 'Publisher';
            return 'Contributor';
        }

        function displayParsedData(data) {
            const table = document.getElementById('parsedDataTable');
            const section = document.getElementById('parsedDataSection');
            
            if (!data || data.length === 0) return;
            
            // Clear table
            table.innerHTML = '';
            
            // Add rows
            let totalPercentage = 0;
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #E2E8F0';
                row.style.backgroundColor = index % 2 === 0 ? 'white' : 'var(--light)';
                
                row.innerHTML = `
                    <td style="padding: 12px 15px;">${item.name}</td>
                    <td style="padding: 12px 15px; font-weight: 600; color: ${item.percentage >= 20 ? 'var(--success)' : 'var(--dark)'}">
                        ${item.percentage}%
                    </td>
                    <td style="padding: 12px 15px;">${item.role}</td>
                    <td style="padding: 12px 15px; font-family: monospace; font-size: 13px; color: var(--blockchain);">
                        ${item.wallet.substring(0, 10)}...
                    </td>
                `;
                
                table.appendChild(row);
                totalPercentage += item.percentage;
            });
            
            // Update total
            document.getElementById('totalPercentageDisplay').textContent = 
                `${Math.round(totalPercentage)}%`;
            
            // Show the section
            section.style.display = 'block';
        }

        function displayFileInfo(fileName, contributorCount, corrections = 0) {
            const totalPercentage = currentData.reduce((sum, item) => sum + item.percentage, 0);
            
            const grid = document.getElementById('fileInfoGrid');
            grid.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Filename</div>
                    <div class="info-value">${fileName}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Contributors</div>
                    <div class="info-value">${contributorCount}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Split</div>
                    <div class="info-value ${totalPercentage === 100 ? 'verified' : ''}">${totalPercentage}%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">${corrections > 0 ? 'Auto-Corrected' : 'Status'}</div>
                    <div class="info-value ${corrections > 0 ? '' : 'verified'}">
                        ${corrections > 0 ? `<i class="fas fa-magic" style="color: var(--warning);"></i> ${corrections} fix${corrections > 1 ? 'es' : ''}` : 'âœ“ Ready for Verification'}
                    </div>
                </div>
            `;
        }

        function updateVisualization(data) {
            const total = data.reduce((sum, item) => sum + item.percentage, 0);
            document.getElementById('totalPercentage').textContent = total.toFixed(1) + '%';
            
            let gradient = 'conic-gradient(';
            let currentPercentage = 0;
            
            data.forEach((item, index) => {
                const color = COLORS[index % COLORS.length];
                const endPercentage = currentPercentage + (item.percentage / total * 100);
                gradient += `${color} ${currentPercentage}% ${endPercentage}%, `;
                currentPercentage = endPercentage;
            });
            
            gradient = gradient.slice(0, -2) + ')';
            document.getElementById('pieChart').style.background = gradient;
            
            const legend = document.getElementById('legendContainer');
            legend.innerHTML = data.map((item, index) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${COLORS[index % COLORS.length]};"></div>
                    <div class="legend-info">
                        <div class="legend-name">${item.name}</div>
                        <div class="legend-percentage">${item.percentage}% â€¢ ${item.role}</div>
                    </div>
                </div>
            `).join('');
        }

        function clearUpload() {
            currentData = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('parsedDataSection').style.display = 'none';
            document.getElementById('legendContainer').innerHTML = '';
            document.getElementById('totalPercentage').textContent = '0%';
            document.getElementById('downloadPdfBtn').style.display = 'none';
            
            // Reset progress steps
            steps[0].classList.remove('completed');
            steps[1].classList.remove('active', 'completed');
        }

        async function downloadPDF() {
            if (currentData.length === 0) {
                alert('No data to export. Please upload a split sheet first.');
                return;
            }

            const btn = document.getElementById('downloadPdfBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Verification Report...';
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title
                doc.setFontSize(24);
                doc.setTextColor(15, 27, 61);
                doc.text('EXECUTION REFERENCE VERIFICATION REPORT', 105, 25, { align: 'center' });
                
                // Powered by Roya
                doc.setFontSize(10);
                doc.setTextColor(100, 116, 139);
                doc.text('Generated by Roya - Transparency & Verification Layer', 105, 33, { align: 'center' });
                
                // Evaluation Environment Notice
                doc.setFontSize(9);
                doc.setTextColor(239, 68, 68);
                doc.text('EVALUATION ENVIRONMENT - FOR REVIEW PURPOSES ONLY', 105, 40, { align: 'center' });
                
                // Blockchain Info
                doc.setFontSize(9);
                doc.setTextColor(139, 92, 246);
                doc.text('Deployed on Monad Testnet (Evaluation)', 105, 46, { align: 'center' });
                doc.text('Contract: 0xAa19bFC7Bd852efe49ef31297bB082FB044B2ea4', 105, 52, { align: 'center' });
                
                // Date
                doc.setFontSize(10);
                doc.setTextColor(100, 116, 139);
                const now = new Date();
                doc.text(`Generated: ${now.toLocaleString()}`, 105, 60, { align: 'center' });
                
                // Section Header
                doc.setFontSize(14);
                doc.setTextColor(15, 27, 61);
                doc.text('Royalty Split Analysis (For Review)', 20, 75);
                
                // Table Header
                const startY = 85;
                doc.setFillColor(15, 27, 61);
                doc.rect(20, startY, 170, 10, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('Name', 25, startY + 7);
                doc.text('Role', 75, startY + 7);
                doc.text('Percentage', 125, startY + 7);
                doc.text('Wallet', 160, startY + 7);
                
                // Table Rows
                let y = startY + 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                
                currentData.forEach((contributor, index) => {
                    // Alternating row colors
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 250, 252);
                        doc.rect(20, y, 170, 10, 'F');
                    }
                    
                    doc.text(contributor.name, 25, y + 7);
                    doc.text(contributor.role, 75, y + 7);
                    doc.text(`${contributor.percentage}%`, 125, y + 7);
                    
                    // Truncate wallet address
                    const wallet = contributor.wallet || 'N/A';
                    const shortWallet = wallet.length > 10 ? wallet.substring(0, 6) + '...' + wallet.substring(wallet.length - 4) : wallet;
                    doc.text(shortWallet, 160, y + 7);
                    
                    y += 10;
                    
                    // Add new page if needed
                    if (y > 270 && index < currentData.length - 1) {
                        doc.addPage();
                        y = 20;
                    }
                });
                
                // Total
                y += 5;
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(16, 185, 129);
                const total = currentData.reduce((sum, item) => sum + item.percentage, 0);
                doc.text(`Total Split: ${total}%`, 125, y + 7);
                
                // Disclaimer
                y += 15;
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 116, 139);
                
                const disclaimerText = 'This document is an execution reference verification report generated for evaluation purposes. It represents sample data and workflow verification. No actual payments are initiated or processed. This output is designed for review by accounting or payment systems for workflow evaluation.';
                const splitText = doc.splitTextToSize(disclaimerText, 170);
                doc.text(splitText, 20, y + 10);
                
                // IP Protection Notice
                y += 25;
                doc.setFontSize(8);
                doc.setTextColor(239, 68, 68);
                doc.text('EVALUATION PROTOTYPE - FOR TECHNICAL REVIEW ONLY', 105, y + 10, { align: 'center' });
                doc.text('Intellectual Property Protected Â© 2026 Roya', 105, y + 15, { align: 'center' });
                
                // Save the PDF
                const fileName = `Roya_Verification_Report_${new Date().getTime()}.pdf`;
                doc.save(fileName);
                
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Report Downloaded';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate verification report. Please try again.');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        function createSmartContract() {
            if (currentData.length === 0) {
                alert('Please upload a file first');
                return;
            }
            
            const btn = document.getElementById('createContractBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Execution Reference...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Execution Reference Created!';
                btn.style.background = 'var(--success)';
                
                // Switch to blockchain tab to show contract details
                setTimeout(() => {
                    switchTab('blockchain');
                    
                    // After showing blockchain tab, auto-advance to payment flow
                    setTimeout(() => {
                        switchTab('payments');
                    }, 2500);
                }, 1000);
            }, 2000);
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask to connect');
                    window.open('https://metamask.io', '_blank');
                    return;
                }
                
                const btn = document.getElementById('connectBtn');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
                
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                userWallet = accounts[0];
                
                const chainId = await ethereum.request({ method: 'eth_chainId' });
                if (chainId !== CONFIG.MONAD_TESTNET.chainId) {
                    const switchOk = confirm('Switch to Monad Testnet?');
                    if (switchOk) await switchToMonadTestnet();
                }
                
                const walletStatus = document.getElementById('walletStatus');
                walletStatus.style.display = 'block';
                walletStatus.innerHTML = `
                    <div style="color: var(--success); font-weight: 600; margin-bottom: 10px;">
                        <i class="fas fa-check-circle"></i> Wallet Connected (Evaluation)
                    </div>
                    <div style="font-family: monospace; font-size: 14px; color: var(--gray);">
                        ${userWallet.substring(0, 8)}...${userWallet.substring(userWallet.length - 6)}
                    </div>
                `;
                
                btn.innerHTML = '<i class="fas fa-check"></i> Wallet Connected';
                btn.style.background = 'var(--success)';
                
            } catch (error) {
                console.error('Wallet connection failed:', error);
                alert('Connection failed: ' + error.message);
                
                const btn = document.getElementById('connectBtn');
                btn.innerHTML = '<i class="fas fa-wallet"></i> Connect MetaMask';
                btn.disabled = false;
            }
        }

        async function switchToMonadTestnet() {
            try {
                await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CONFIG.MONAD_TESTNET.chainId }] });
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await ethereum.request({ method: 'wallet_addEthereumChain', params: [CONFIG.MONAD_TESTNET] });
                        return true;
                    } catch (addError) {
                        console.error('Failed to add network:', addError);
                        return false;
                    }
                }
                return false;
            }
        }

        function simulatePayment() {
            if (currentData.length === 0) {
                alert('Please upload a split sheet first');
                return;
            }
            
            const btn = document.getElementById('simulatePaymentBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Simulating Distribution...';
            btn.disabled = true;
            
            document.getElementById('paymentDetails').style.display = 'block';
            
            animatePaymentSteps();
            
            const distributionDiv = document.getElementById('paymentDistribution');
            const totalAmount = 50000;
            
            distributionDiv.innerHTML = currentData.map((contributor, index) => {
                const amount = (totalAmount * contributor.percentage / 100).toFixed(2);
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: var(--radius); margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${COLORS[index % COLORS.length]};"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--dark);">${contributor.name}</div>
                                <div style="font-size: 13px; color: var(--gray);">${contributor.role}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: var(--success); font-size: 18px;">$${amount}</div>
                            <div style="font-size: 13px; color: var(--gray);">${contributor.percentage}%</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Simulation Complete';
                btn.style.background = 'var(--success)';
                
                // Show additional disclaimer
                alert('âœ… Simulation Complete\n\nThis simulation generated sample payment instructions for review purposes only.\n\nâ€¢ No actual payments were initiated\nâ€¢ All outputs are for workflow evaluation\nâ€¢ Review the distribution above for verification');
            }, 4000);
        }

        function animatePaymentSteps() {
            const paymentSteps = ['paymentStep1', 'paymentStep2', 'paymentStep3', 'paymentStep4'];
            
            paymentSteps.forEach((stepId, index) => {
                setTimeout(() => {
                    document.getElementById(stepId).classList.add('active');
                    
                    setTimeout(() => {
                        document.getElementById(stepId).classList.remove('active');
                        document.getElementById(stepId).classList.add('completed');
                    }, 800);
                }, index * 1000);
            });
        }
    </script>
</body>
</html>